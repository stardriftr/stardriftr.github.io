<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="/style.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STAR DRIFTR ‚Äî Login</title>
</head>
<body>
  <img src="star_driftr_logo.png" alt="STAR DRIFTR Logo" class="logo" />
  <header>
    <p>Log in or sign up to post your dreams anonymously</p>
  </header>

  <button id="google-signin">Sign in with Google</button>

  <div id="user-info"></div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBkI9Gnob-bIpZL0m6E8pf7lO8f7dlrYYg",
    authDomain: "stardriftr.firebaseapp.com",
    projectId: "stardriftr",
    storageBucket: "stardriftr.firebasestorage.app",
    messagingSenderId: "115649067004",
    appId: "1:115649067004:web:e24fdd5a8447f92f342479",
    measurementId: "G-Q62KZDRBWG"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const btn = document.getElementById('google-signin');
  const userInfo = document.getElementById('user-info');

  onAuthStateChanged(auth, async user => {
    if (user) {
      console.log("‚úÖ User signed in:", user.uid);
      btn.style.display = 'none';

      try {
        // Fetch profile
        console.log("üîÑ Fetching profile from /users...");
        const res = await fetch('https://stardriftr-api.calembeaz.workers.dev/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: user.uid }),
        });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const profile = await res.json();

        console.log("‚úÖ User profile loaded:", profile);
        userInfo.textContent = `Hello, ${profile.username}`;

        // Save UID, username, and display_name to localStorage
        localStorage.setItem('uid', user.uid);
        localStorage.setItem('username', profile.username);
        localStorage.setItem('display_name', profile.display_name || profile.username);


        // Check for selectedDreamText
        const selectedDream = localStorage.getItem('selectedDreamText');
        const generateImage = localStorage.getItem('generateImage') === 'true'; // grab from localStorage

        if (selectedDream) {
          console.log("üîÑ Posting selectedDreamText to worker...");
          const dreamRes = await fetch('https://stardriftr-api.calembeaz.workers.dev/dreams', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              uid: user.uid,
              text: selectedDream,
              generateImage: !!generateImage   // ensures boolean true/false
            }),
          });
          if (!dreamRes.ok) throw new Error(`Failed to post dream: ${dreamRes.status}`);
          const dreamData = await dreamRes.json();
          console.log("‚úÖ Dream posted:", dreamData);

          // Clear selectedDreamText so it doesn't re-post
          localStorage.removeItem('selectedDreamText');
          localStorage.removeItem('generateImage');
        }

        console.log("‚û°Ô∏è Redirecting to timeline...");
        window.location.href = 'timeline.html';

      } catch (err) {
        console.error("‚ùå Error fetching profile or posting dream:", err);
        userInfo.textContent = `Failed: ${err.message}`;
        btn.style.display = 'block';
      }

    } else {
      console.log("‚ÑπÔ∏è No user is signed in");
      btn.style.display = 'block';
      userInfo.textContent = '';
    }
  });

  btn.addEventListener('click', async () => {
    btn.disabled = true;
    const provider = new GoogleAuthProvider();
    console.log("üîò Sign-in button clicked");
    try {
      await signInWithPopup(auth, provider);
      console.log("‚úÖ Sign-in popup success");
    } catch (error) {
      console.error("‚ùå Sign-in error:", error);
      userInfo.textContent = `Sign-in error: ${error.message}`;
      btn.disabled = false;
    }
  });
  </script>
</body>
</html>
