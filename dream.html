<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://stardriftr.github.io/style.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dream</title>
</head>
<body>
  <header id="header">
    <img
      src="https://raw.githubusercontent.com/stardriftr/stardriftr.github.io/main/images/star_driftr_logo.png"
      alt="STAR DRIFTR Logo"
      class="logo"
      onclick="goHome()"
    />
    <div
      class="header-right"
      onclick="toggleMenu()"
      aria-label="Menu"
      role="button"
      tabindex="0"
    >
      <svg class="hamburger" viewBox="0 0 24 24" aria-hidden="true">
        <rect y="4" width="24" height="2" rx="1"></rect>
        <rect y="11" width="24" height="2" rx="1"></rect>
        <rect y="18" width="24" height="2" rx="1"></rect>
      </svg>
    </div>
  </header>

  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="timeline" id="dream-container"></div>

  <div id="popup"></div>

  <nav id="bottom-bar" aria-label="Bottom navigation">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" aria-label="Home" tabindex="0" onclick="goHome()">
      <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
  </nav>

  <!-- Load dreamCard.js -->
  <script type="module">
    import { createDreamCard } from './dreamCard.js';

    const API_URL = 'https://stardriftr-api.calembeaz.workers.dev/dreams';
    const dreamContainer = document.getElementById('dream-container');
    const dreamId = new URLSearchParams(window.location.search).get('id');
    const currentUid = localStorage.getItem('uid');
    const currentDisplayName = localStorage.getItem('display_name');

    function showPopup(msg) {
      const popup = document.getElementById("popup");
      popup.textContent = msg;
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 3000);
    }

    async function loadDream() {
      try {
        const res = await fetch(`${API_URL}/${dreamId}`);
        if (!res.ok) throw new Error("Failed to fetch dream");
        const d = await res.json();

        // Clear container
        dreamContainer.innerHTML = '';

        // Use dreamCard.js to render the main dream card
        const card = createDreamCard(d, 0);
        if (card) dreamContainer.appendChild(card);

        // --- Comments section ---
        const commentsDiv = document.createElement('div');
        commentsDiv.id = 'comments-section';
        commentsDiv.style.marginTop = '15px';
        commentsDiv.innerHTML = `
          <h3 style="margin-bottom:10px; font-size:16px; color:#ccc;">Comments</h3>
          <div id="comments-list"></div>
          <div id="comment-form" style="margin-top:10px;">
            <textarea id="comment-input" placeholder="Write a comment..." style="width:100%; min-height:60px; border-radius:6px; padding:6px;"></textarea>
            <button id="post-comment-btn" style="margin-top:6px; padding:6px 12px; border-radius:6px; cursor:pointer;">Post</button>
          </div>
        `;
        dreamContainer.appendChild(commentsDiv);

        document.getElementById('post-comment-btn').addEventListener('click', postComment);

        await loadComments(); // load comments immediately

      } catch (err) {
        console.error(err);
        showPopup("Error loading dream");
      } finally {
        document.getElementById('loading-overlay').style.display = 'none';
      }
    }

    async function loadComments() {
      try {
        const res = await fetch(`${API_URL}/${dreamId}/comments`);
        if (!res.ok) throw new Error("Failed to fetch comments");
        const comments = await res.json();

        const commentsList = document.getElementById('comments-list');
        if (!commentsList) return;

        commentsList.innerHTML = '';
        comments.sort((a, b) => a.ts - b.ts);

        comments.forEach(c => {
          const div = document.createElement('div');
          div.className = 'comment';
          const ts = new Date(Number(c.ts)).toLocaleString();
          const name = c.display_name?.trim() || c.username || "Anon";
          div.innerHTML = `
            <div class="comment-meta" style="font-size:14px; color:#ccc; margin-bottom:4px;">
              <span>üìù</span>
              <a href="/user.html?username=${c.username}" style="text-decoration:none; color:inherit;">${name}</a>
              <span style="font-size:12px; color:#888;">${ts}</span>
            </div>
            <div class="comment-body" style="font-size:14px; color:#eee;">${c.text}</div>
          `;
          commentsList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        showPopup("Error loading comments");
      }
    }

    async function postComment() {
      const input = document.getElementById('comment-input');
      const text = input.value.trim();
      if (!text) return;
      if (!currentUid) return showPopup("You must be logged in to comment");

      try {
        const displayName = currentDisplayName || localStorage.getItem('username') || "Anon";

        await fetch(`${API_URL}/${dreamId}/comment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uid: currentUid,
            display_name: displayName,
            text
          })
        });

        input.value = '';
        await loadComments(); // reload comments after posting
      } catch (err) {
        console.error(err);
        showPopup("Error posting comment");
      }
    }

    function goHome() { window.location.href = "index.html"; }

    window.addEventListener('load', loadDream);
  </script>
</body>
</html>
