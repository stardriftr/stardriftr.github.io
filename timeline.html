<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="style.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dream Timeline</title>
</head>
<body>
  <header id="header">
    <img
      src="https://raw.githubusercontent.com/stardriftr/stardriftr.github.io/main/images/star_driftr_logo.png"
      alt="STAR DRIFTR Logo"
      class="logo"
      onclick="goHome()"
    />
    <div
      class="header-right"
      onclick="toggleMenu()"
      aria-label="Menu"
      role="button"
      tabindex="0"
    >
      <svg class="hamburger" viewBox="0 0 24 24" aria-hidden="true">
        <rect y="4" width="24" height="2" rx="1"></rect>
        <rect y="11" width="24" height="2" rx="1"></rect>
        <rect y="18" width="24" height="2" rx="1"></rect>
      </svg>
    </div>
  </header>

  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="timeline" id="timeline"></div>

  <div id="popup" style="display: none;"></div>

  <button class="post-fab" onclick="goToTop()">Post</button>

  <nav id="bottom-bar" aria-label="Bottom navigation">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" aria-label="Home" tabindex="0" onclick="void(0)">
      <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" aria-label="Search" tabindex="0" onclick="void(0)">
      <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16a6.471 6.471 0 004.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14A4.5 4.5 0 119.5 5a4.5 4.5 0 010 9z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" aria-label="Profile" tabindex="0"
         onclick="(() => {
           const username = localStorage.getItem('username');
           if (username) {
             window.location.href = `/user.html?username=${username}`;
           } else {
             showPopup('You must be logged in to view your profile');
           }
         })()">
      <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/>
    </svg>
  </nav>

<script type="module">
import { createDreamCard } from './dreamCard.js';

const API_URL = 'https://stardriftr-api.calembeaz.workers.dev/dreams';
const timeline = document.getElementById('timeline');

function goHome() { window.location.href = "index.html"; }
function goToTop() { window.location.href = 'index.html'; }
function showPopup(msg) {
  const popup = document.getElementById("popup");
  popup.textContent = msg;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 3000);
}

function randomEmoji() {
  const emojis = ['😴', '🌌', '👁️', '🌀', '🌙', '🛌'];
  return emojis[Math.floor(Math.random() * emojis.length)];
}

function fallbackAnon(i) {
  return 'Anon-' + String(1000 + i);
}

async function loadTimeline() {
  const loadingOverlay = document.getElementById('loading-overlay');
  loadingOverlay.style.display = 'block';
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error(`Failed to fetch timeline: ${res.status}`);
    const dreams = await res.json();
    timeline.innerHTML = '';
    dreams.sort((a,b) => Number(b.time)-Number(a.time))
          .forEach((d,i) => {
            const card = createDreamCard(d,i);
            if (card) timeline.appendChild(card);
          });
  } catch(err) {
    console.error(err);
    showPopup("Error loading timeline: " + err.message);
  } finally {
    loadingOverlay.style.display = 'none';
  }
}

async function postPendingDream() {
  const selectedDream = localStorage.getItem('selectedDreamText');
  const pendingDream = localStorage.getItem('pendingDream');
  const generateImage = localStorage.getItem('generateImage') === 'true';
  const uid = localStorage.getItem('uid');

  if (selectedDream && pendingDream && uid) {
    console.log("🔄 Posting dream:", {uid, pendingDream, selectedDream, generateImage});

    try {
      const dreamRes = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          uid,
          pendingDream,
          selectedDreamText: selectedDream,
          generateImage
        }),
      });

      if (!dreamRes.ok) throw new Error(`Failed to post dream: ${dreamRes.status}`);
      const dreamData = await dreamRes.json();
      console.log("✅ Dream posted:", dreamData);

      // Clear localStorage so it doesn’t re-post
      localStorage.removeItem('selectedDreamText');
      localStorage.removeItem('generateImage');
      localStorage.removeItem('pendingDream');
    } catch (err) {
      console.error("❌ Error posting dream:", err);
      showPopup("Failed to post dream: " + err.message);
    }
  }
}

// ---------- Handle both first load and bfcache navigation ----------
window.addEventListener('pageshow', async (event) => {
  if (event.persisted || !document.wasPosted) {
    await postPendingDream();
    await loadTimeline();
    document.wasPosted = true;
  }
});
</script>
</body>
</html>
