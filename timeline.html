<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="style.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dream Timeline</title>
  <style>
    /* Dream uploading bar styling */
    #dream-uploading-box {
      display: none;
      position: sticky;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #1a1a1a;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: bold;
      z-index: 1000;
      border-top: 1px solid #444;
    }

    /* Spinner inside dream uploading box */
    #dream-uploading-box .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid #444;
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body>
  <!-- Header will be injected -->
  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="timeline" id="timeline"></div>

  <div id="popup" style="display: none;"></div>

  <button class="post-fab" onclick="goToTop()">Post</button>

  <!-- Dream uploading bar -->
  <div id="dream-uploading-box">
    <div class="spinner"></div>
    <span>Dream uploading...</span>
  </div>

  <!-- Footer will be injected -->

<script type="module">
import { createDreamCard } from './dreamCard.js';
import { createHeader } from './header.js';
import { createFooter } from './footer.js';

const API_URL = 'https://stardriftr-api.calembeaz.workers.dev/dreams';
const timeline = document.getElementById('timeline');

// Inject header and footer
document.body.prepend(createHeader());
document.body.appendChild(createFooter());

function goHome() { window.location.href = "index.html"; }
function goToTop() { window.location.href = 'index.html'; }
function showPopup(msg) {
  const popup = document.getElementById("popup");
  popup.textContent = msg;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 3000);
}

function randomEmoji() {
  const emojis = ['😴', '🌌', '👁️', '🌀', '🌙', '🛌'];
  return emojis[Math.floor(Math.random() * emojis.length)];
}

function fallbackAnon(i) {
  return 'Anon-' + String(1000 + i);
}

async function loadTimeline() {
  const loadingOverlay = document.getElementById('loading-overlay');
  loadingOverlay.style.display = 'block';
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error(`Failed to fetch timeline: ${res.status}`);
    const dreams = await res.json();
    timeline.innerHTML = '';
    dreams.sort((a,b) => Number(b.time)-Number(a.time))
          .forEach((d,i) => {
            const card = createDreamCard(d,i);
            if (card) timeline.appendChild(card);
          });
  } catch(err) {
    console.error(err);
    showPopup("Error loading timeline: " + err.message);
  } finally {
    loadingOverlay.style.display = 'none';
  }
}

async function postPendingDream() {
  const selectedDream = localStorage.getItem('selectedDreamText');
  const pendingDream = localStorage.getItem('pendingDream');
  const generateImage = localStorage.getItem('generateImage') === 'true';
  const uid = localStorage.getItem('uid');

  // Only show uploading bar if there’s a real pending dream
  if (selectedDream?.trim() && pendingDream?.trim() && uid?.trim()) {
    const uploadingBox = document.getElementById('dream-uploading-box');
    uploadingBox.style.display = 'flex';

    console.log("🔄 Posting dream:", {uid, pendingDream, selectedDream, generateImage});

    try {
      const dreamRes = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          uid,
          pendingDream,
          selectedDreamText: selectedDream,
          generateImage
        }),
      });

      if (!dreamRes.ok) throw new Error(`Failed to post dream: ${dreamRes.status}`);
      const dreamData = await dreamRes.json();
      console.log("✅ Dream posted:", dreamData);

      // Clear localStorage so it doesn’t re-post
      localStorage.removeItem('selectedDreamText');
      localStorage.removeItem('generateImage');
      localStorage.removeItem('pendingDream');

    } catch (err) {
      console.error("❌ Error posting dream:", err);
      showPopup("Failed to post dream: " + err.message);
    } finally {
      // Hide uploading box after post is complete
      const uploadingBox = document.getElementById('dream-uploading-box');
      uploadingBox.style.display = 'none';
    }
  }
}

// ---------- Handle both first load and bfcache navigation ----------
window.addEventListener('pageshow', async (event) => {
  if (event.persisted || !document.wasPosted) {
    await loadTimeline();
    await postPendingDream();
    document.wasPosted = true;
  }
});
</script>
</body>
</html>
