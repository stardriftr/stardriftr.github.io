<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="https://stardriftr.github.io/style.css">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>User Profile</title>
</head>
<body>
  <!-- Header will be injected -->

  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="timeline" id="timeline"></div>
  <div id="popup" style="display: none;"></div>
  <button class="post-fab" onclick="goToTop()">Post</button>

  <!-- Footer will be injected -->

<script type="module">
import { createDreamCard } from './dreamCard.js';
import { createHeader } from './header.js';
import { createFooter } from './footer.js';

const API_URL = 'https://stardriftr-api.calembeaz.workers.dev';
const timeline = document.getElementById('timeline');

// Inject header and footer
document.body.prepend(createHeader());
document.body.appendChild(createFooter());

function randomEmoji() {
  const emojis = ['😴', '🌌', '👁️', '🌀', '🌙', '🛌'];
  return emojis[Math.floor(Math.random() * emojis.length)];
}

function fallbackAnon(i) {
  return 'Anon-' + String(1000 + i);
}

function showPopup(msg) {
  const popup = document.getElementById("popup");
  popup.textContent = msg;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 3000);
}

function goHome() { window.location.href = "index.html"; }
function goToTop() { window.location.href = 'index.html'; }

async function fetchDreamWithLikes(dreamId, i) {
  try {
    const res = await fetch(`${API_URL}/dreams/${dreamId}`);
    if (!res.ok) return null;
    const d = await res.json();

    const likeCountRes = await fetch(`${API_URL}/dreams/${dreamId}:like_count`);
    let likeCount = 0;
    if (likeCountRes.ok) {
      const countText = await likeCountRes.text();
      likeCount = Number(countText) || 0;
    }
    d.like_count = likeCount;
    return d;
  } catch(e) { 
    console.error(`Failed to fetch dream ${dreamId}:`, e); 
    return null; 
  }
}

async function loadUserProfile() {
  const loadingOverlay = document.getElementById('loading-overlay');
  const currentUid = localStorage.getItem('uid');

  try {
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username');
    if (!username) throw new Error('No username provided');

    const profileRes = await fetch(`${API_URL}/profile/${username}`);
    if (!profileRes.ok) throw new Error(`Profile not found: ${profileRes.status}`);
    const profile = await profileRes.json();

    // Fetch user's posted dreams
    const dreams = await Promise.all(profile.dreams.map((dreamId, i) => fetchDreamWithLikes(dreamId, i)));

    // Fetch user's liked dreams
    const likedDreams = profile.liked_dreams ? await Promise.all(profile.liked_dreams.map((dreamId, i) => fetchDreamWithLikes(dreamId, i))) : [];

    // Map all dreams for easy lookup
    const allDreamsMap = {};
    [...dreams, ...likedDreams].filter(Boolean).forEach(d => { allDreamsMap[d.dream_id] = d; });

    // Add profile header
    const profileHeader = document.createElement('div');
    profileHeader.className = 'user-profile-header';
    profileHeader.innerHTML = `
      <h2>${profile.display_name}</h2>
      <p class="username-handle">@${profile.username}</p>
      <div class="tabs" style="display:flex; gap:20px; margin-top:12px;">
        <span id="postsTab" style="cursor:pointer; font-weight:bold; border-bottom:2px solid #5492a5; padding-bottom:4px;">Posts</span>
        <span id="likesTab" style="cursor:pointer; padding-bottom:4px;">Likes</span>
      </div>
    `;
    timeline.parentElement.insertBefore(profileHeader, timeline);
    profileHeader.style.paddingBottom = '60px';

    const postsTab = document.getElementById('postsTab');
    const likesTab = document.getElementById('likesTab');

    // Function to render any list of dream IDs using dreamCard.js
    function renderDreams(dreamIds) {
      timeline.innerHTML = '';
      const dreamsToShow = dreamIds.map(did => allDreamsMap[did]).filter(Boolean);
      const sortedDreams = dreamsToShow.sort((a,b) => Number(b.time) - Number(a.time));

      sortedDreams.forEach((d, i) => {
        const card = createDreamCard(d, i);
        if (card) timeline.appendChild(card);
      });
    }

    // Initial render: Posts
    renderDreams(profile.dreams);

    // Tab event listeners
    postsTab.addEventListener('click', () => {
      postsTab.style.borderBottom = '2px solid #5492a5';
      likesTab.style.borderBottom = 'none';
      renderDreams(profile.dreams);
    });

    likesTab.addEventListener('click', async () => {
      likesTab.style.borderBottom = '2px solid #5492a5';
      postsTab.style.borderBottom = 'none';
      timeline.innerHTML = '';

      if (!profile.liked_dreams || profile.liked_dreams.length === 0) {
        timeline.innerHTML = '<p style="color:#aaa;">No liked dreams yet.</p>';
        return;
      }

      // Fetch liked dreams and add them to allDreamsMap
      for (const dreamId of profile.liked_dreams) {
        if (!allDreamsMap[dreamId]) {
          const res = await fetch(`${API_URL}/dreams/${dreamId}`);
          if (res.ok) {
            const dream = await res.json();

            const likeCountRes = await fetch(`${API_URL}/dreams/${dreamId}:like_count`);
            dream.like_count = likeCountRes.ok ? Number(await likeCountRes.text()) || 0 : 0;

            allDreamsMap[dreamId] = dream;
          }
        }
      }

      // Now render using IDs, as renderDreams expects
      renderDreams(profile.liked_dreams);
    });


  } catch (err) {
    console.error('Error loading user profile:', err);
    showPopup(`Error loading profile: ${err.message}`);
  } finally {
    loadingOverlay.style.display = 'none';
  }
}

window.addEventListener('load', loadUserProfile);
</script>
</body>
</html>
