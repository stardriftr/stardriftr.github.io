<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="https://stardriftr.github.io/style.css">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>User Profile</title>
</head>
<body>
<header id="header">
  <img
    src="https://raw.githubusercontent.com/stardriftr/stardriftr.github.io/main/images/star_driftr_logo.png"
    alt="STAR DRIFTR Logo"
    class="logo"
    onclick="goHome()"
  />
  <div
    class="header-right"
    onclick="toggleMenu()"
    aria-label="Menu"
    role="button"
    tabindex="0"
  >
    <svg class="hamburger" viewBox="0 0 24 24" aria-hidden="true">
      <rect y="4" width="24" height="2" rx="1"></rect>
      <rect y="11" width="24" height="2" rx="1"></rect>
      <rect y="18" width="24" height="2" rx="1"></rect>
    </svg>
  </div>
</header>

<div id="loading-overlay">
  <div class="spinner"></div>
</div>

<div class="timeline" id="timeline"></div>
<div id="popup"></div>
<button class="post-fab" onclick="goToTop()">Post</button>

<nav id="bottom-bar" aria-label="Bottom navigation">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" aria-label="Home" tabindex="0" onclick="void(0)">
    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" aria-label="Search" tabindex="0" onclick="void(0)">
    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16a6.471 6.471 0 004.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14A4.5 4.5 0 119.5 5a4.5 4.5 0 010 9z"/>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" aria-label="Profile" tabindex="0" onclick="void(0)">
    <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/>
  </svg>
</nav>

<script>
const API_URL = 'https://stardriftr-api.calembeaz.workers.dev';
const timeline = document.getElementById('timeline');

function randomEmoji() {
  const emojis = ['ðŸ˜´', 'ðŸŒŒ', 'ðŸ‘ï¸', 'ðŸŒ€', 'ðŸŒ™', 'ðŸ›Œ'];
  return emojis[Math.floor(Math.random() * emojis.length)];
}

function fallbackAnon(i) {
  return 'Anon-' + String(1000 + i);
}

function showPopup(msg) {
  const popup = document.getElementById("popup");
  popup.textContent = msg;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 3000);
}

function goHome() { window.location.href = "index.html"; }
function goToTop() { window.location.href = 'index.html'; }

async function loadUserProfile() {
  const loadingOverlay = document.getElementById('loading-overlay');
  const currentUid = localStorage.getItem('uid');

  try {
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username');
    if (!username) throw new Error('No username provided');

    const profileRes = await fetch(`${API_URL}/profile/${username}`);
    if (!profileRes.ok) throw new Error(`Profile not found: ${profileRes.status}`);
    const profile = await profileRes.json();

    // Fetch dreams and like counts
    const dreams = await Promise.all(profile.dreams.map(async (dreamId, i) => {
      try {
        const res = await fetch(`${API_URL}/dreams/${dreamId}`);
        if (!res.ok) return null;
        const d = await res.json();
        const likeCountRes = await fetch(`${API_URL}/dreams/${dreamId}:like_count`);
        let likeCount = 0;
        if (likeCountRes.ok) {
          const countText = await likeCountRes.text();
          likeCount = Number(countText) || 0;
        }
        d.like_count = likeCount;
        return d;
      } catch(e) { console.error(`Failed to fetch dream ${dreamId}:`, e); return null; }
    }));

    // Map all dreams for easy lookup
    const allDreamsMap = {};
    dreams.filter(Boolean).forEach(d => { allDreamsMap[d.dream_id] = d; });

    // Add profile header
    const profileHeader = document.createElement('div');
    profileHeader.className = 'user-profile-header';
    profileHeader.innerHTML = `
      <h2>${profile.display_name}</h2>
      <p class="username-handle">@${profile.username}</p>
      <div class="tabs" style="display:flex; gap:20px; margin-top:12px;">
        <span id="postsTab" style="cursor:pointer; font-weight:bold; border-bottom:2px solid #5492a5; padding-bottom:4px;">Posts</span>
        <span id="likesTab" style="cursor:pointer; padding-bottom:4px;">Likes</span>
      </div>
    `;
    timeline.parentElement.insertBefore(profileHeader, timeline);
    profileHeader.style.paddingBottom = '60px';

    const postsTab = document.getElementById('postsTab');
    const likesTab = document.getElementById('likesTab');

    // Function to render any list of dream IDs
    function renderDreams(dreamIds) {
      timeline.innerHTML = '';
      const dreamsToShow = dreamIds.map(did => allDreamsMap[did]).filter(Boolean);
      const sortedDreams = dreamsToShow.sort((a,b) => Number(b.time) - Number(a.time));

      sortedDreams.forEach((d, i) => {
        if (!d || !d.original) return;
        const div = document.createElement('div');
        div.className = 'dream';
        const name = d.display_name?.trim() || fallbackAnon(i);
        const fullText = d.original;
        const isTruncated = fullText.length > 200;
        const displayText = isTruncated ? fullText.slice(0, 200) + '...' : fullText;
        const hasLiked = d.likes?.includes(currentUid) || false;
        const likeCount = d.like_count || 0;

        div.innerHTML = `
          <div class="meta">
            <span>
              <span class="emoji">${randomEmoji()}</span> 
              <a href="/user.html?username=${d.username}" class="username" style="color:inherit; text-decoration:none; font-weight:bold; cursor:pointer;">
                ${name}
              </a>
            </span>
            <span>${new Date(Number(d.time)).toLocaleString()}</span>
          </div>
          <div class="image-container">
            ${ d.image ? `<div class="shimmer-box" style="width:100%; height:460px; border-radius:6px;"></div>` : '' }
          </div>
          <div class="body">
            ${displayText}
            ${ isTruncated ? `<div class="expand-link" style="color:#5492a5; cursor:pointer; font-weight:bold; text-decoration:none; margin-top:4px;">Expand full dream</div>` : '' }
          </div>
          <div class="actions" style="display:flex; align-items:center; gap:12px;">
            <div style="display:flex; align-items:center; gap:4px; cursor:pointer;">
              <svg class="like-icon" data-dream-id="${d.dream_id}" data-liked="${hasLiked}" viewBox="0 0 24 24" style="fill:${hasLiked ? 'red' : 'none'}; stroke:${hasLiked ? 'red' : '#999'}; stroke-width:2;">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 
                         2 6 4 4 6.5 4c1.74 0 3.41 1.01 4.13 2.44h.74
                         C13.09 5.01 14.76 4 16.5 4 19 4 21 6 21 8.5
                         c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
              </svg>
              <span class="like-count">${likeCount > 0 ? likeCount : ''}</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px; cursor:pointer;" onclick="window.location.href='dream.html?id=${d.dream_id}'">
              <svg viewBox="0 0 24 24" style="stroke:#999; fill:none;">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z"/>
              </svg>
              <span class="comment-count">${d.comment_count > 0 ? d.comment_count : ''}</span>
            </div>
          </div>
        `;

        if (d.image) {
          const container = div.querySelector('.image-container');
          const img = new Image();
          img.src = d.image;
          img.style.maxWidth = '100%';
          img.style.borderRadius = '6px';
          img.onload = () => { container.innerHTML = ''; container.appendChild(img); };
        }

        if (isTruncated) {
          const expandLink = div.querySelector('.expand-link');
          expandLink.addEventListener('click', () => {
            const bodyDiv = expandLink.parentElement;
            if (expandLink.textContent === 'Expand full dream') {
              bodyDiv.innerHTML = fullText + `<div class="expand-link" style="color:#5492a5; cursor:pointer; font-weight:bold; text-decoration:none; margin-top:4px;">Hide full dream</div>`;
              bodyDiv.querySelector('.expand-link').addEventListener('click', () => {
                bodyDiv.innerHTML = displayText + `<div class="expand-link" style="color:#5492a5; cursor:pointer; font-weight:bold; text-decoration:none; margin-top:4px;">Expand full dream</div>`;
                bodyDiv.querySelector('.expand-link').addEventListener('click', arguments.callee);
              });
            }
          });
        }

        timeline.appendChild(div);

        // Like icon handler
        const likeIcon = div.querySelector('.like-icon');
        const likeCountSpan = div.querySelector('.like-count');
        likeIcon.addEventListener('click', async () => {
          const dreamId = likeIcon.dataset.dreamId;
          const uid = currentUid;
          if (!uid) return showPopup("You must be logged in to like");

          const isLiked = likeIcon.dataset.liked === 'true';
          likeIcon.dataset.liked = (!isLiked).toString();
          likeIcon.style.fill = !isLiked ? 'red' : 'none';
          likeIcon.style.stroke = !isLiked ? 'red' : '#999';
          likeCountSpan.textContent = !isLiked ? (likeCount + 1) : (likeCount - 1 || '');

          const endpoint = isLiked ? 'unlike' : 'like';
          try {
            await fetch(`${API_URL}/dreams/${dreamId}/${endpoint}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ uid })
            });
          } catch (err) {
            console.error(err);
            showPopup(`Failed to ${endpoint} dream`);
            likeIcon.dataset.liked = isLiked.toString();
            likeIcon.style.fill = isLiked ? 'red' : 'none';
            likeIcon.style.stroke = isLiked ? 'red' : '#999';
            likeCountSpan.textContent = likeCount > 0 ? likeCount : '';
          }
        });
      });
    }

    // Initial render: Posts
    renderDreams(profile.dreams);

    // Tab event listeners
    postsTab.addEventListener('click', () => {
      postsTab.style.borderBottom = '2px solid #5492a5';
      likesTab.style.borderBottom = 'none';
      renderDreams(profile.dreams);
    });

    likesTab.addEventListener('click', () => {
      likesTab.style.borderBottom = '2px solid #5492a5';
      postsTab.style.borderBottom = 'none';
      renderDreams(profile.liked_dreams || []);
    });

  } catch (err) {
    console.error('Error loading user profile:', err);
    showPopup(`Error loading profile: ${err.message}`);
  } finally {
    loadingOverlay.style.display = 'none';
  }
}

window.addEventListener('load', loadUserProfile);
</script>
</body>
</html>
